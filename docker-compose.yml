version: '3.8'
services:
  cast-service:
    build: .
    container_name: dashboard-cast
    shm_size: 2gb  # Required for Chrome shared memory and Xvfb operation
    environment:
      - PYTHONUNBUFFERED=1  # Real-time log output to stdout
      - DISPLAY=:99  # Xvfb virtual display (managed by XvfbManager)
      # Static Cast device IP (required for Docker - mDNS doesn't work)
      - CAST_DEVICE_IP=10.10.0.31
      # Host IP for stream URLs (REQUIRED for Docker - set to your machine's LAN IP)
      - STREAM_HOST_IP=10.10.0.133  # <-- CHANGE THIS to your Ubuntu machine's IP
      # Optional: Discover Cast device by friendly name
      # - CAST_DEVICE_NAME=Living Room TV
      # Intel QuickSync hardware acceleration
      - LIBVA_DRIVER_NAME=iHD  # Force iHD driver for Gen 8+ Intel GPUs
    # GPU device passthrough - Required for Intel QuickSync hardware acceleration
    devices:
      - /dev/dri:/dev/dri  # Pass entire DRI directory (card0 and renderD128)
    # GPU group permissions - Run scripts/detect-gpu-gids.sh to get actual GIDs
    group_add:
      - "992"  # render GID from VM
      - "44"   # video GID from VM
    # network_mode: host  # Only works on native Linux - not Docker Desktop
    ports:
      - "8000:8000"   # Webhook API
      - "8080:8080"   # HLS streaming server (must be accessible by Cast device)
    restart: unless-stopped
    # Note: Xvfb is started programmatically via XvfbManager, not as a separate service
