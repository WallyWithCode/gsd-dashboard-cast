# Milestone v1.0: Dashboard Cast Service

**Status:** ✅ SHIPPED 2026-01-16
**Phases:** 1-5
**Total Plans:** 12

## Overview

Transform web dashboards into Cast-enabled video streams through five focused phases: establish browser automation foundation with proper resource management, integrate Cast protocol for device connectivity, build FFmpeg video pipeline with quality controls, expose webhook API for automation triggers, and package for production deployment. Each phase delivers independently verifiable capability building toward webhook-triggered dashboard casting for Home Assistant automations.

## Phases

### Phase 1: Browser Foundation

**Goal**: Playwright browser automation with authentication and resource management
**Depends on**: Nothing (first phase)
**Requirements**: BROWSER-01, BROWSER-02, INFRA-01
**Plans**: 2 plans

Plans:
- [x] 01-01: Playwright browser automation with auth injection and cleanup
- [x] 01-02: Docker packaging with shared memory and host networking

**Details:**
- Playwright chromium with headless mode for Docker compatibility
- Context manager pattern for browser lifecycle (__enter__/__exit__)
- Dual auth support: cookies (session-based) and localStorage (token-based)
- Fresh browser instance per request to avoid memory leaks
- Docker-optimized args: --no-sandbox, --disable-dev-shm-usage
- shm_size: 2gb for Chrome SharedArrayBuffer
- network_mode: host for mDNS Cast discovery

### Phase 2: Cast Integration

**Goal**: Cast protocol connectivity with device discovery and playback control
**Depends on**: Phase 1
**Requirements**: CAST-01, CAST-02, CAST-03, CAST-04, CAST-05
**Plans**: 2 plans

Plans:
- [x] 02-01: Cast device discovery and session management with HDMI-CEC wake
- [x] 02-02: Retry mechanism with exponential backoff and comprehensive testing

**Details:**
- pychromecast for mDNS discovery and Cast protocol
- asyncio.run_in_executor for blocking pychromecast calls
- HDMI-CEC wake via set_volume_muted(False)
- Context manager pattern for Cast sessions
- Exponential backoff: max_retries=3, initial_delay=1.0s, backoff_factor=2.0
- Graceful error handling: return empty/None instead of exceptions
- Mock-based testing for isolated testing without Cast devices

### Phase 3: Video Pipeline

**Goal**: FFmpeg encoding with quality configuration for streaming
**Depends on**: Phase 2
**Requirements**: BROWSER-04, WEBHOOK-05
**Plans**: 3 plans

Plans:
- [x] 03-01: FFmpeg encoder with quality configuration and HLS output
- [x] 03-02: Xvfb virtual display management
- [x] 03-03: End-to-end video pipeline integration

**Details:**
- Software encoding (libx264) for v1, hardware acceleration deferred to v2
- HLS output format with 2-second segments
- Quality presets: 1080p (5000kbps), 720p (2500kbps), low-latency (2000kbps)
- Low-latency tuning: zerolatency tune, bf=0, refs=1, g=framerate
- XvfbManager for virtual display (1920x1080x24 default)
- StreamManager orchestrates: Cast discovery → Xvfb → Browser → FFmpeg → Cast session
- Duration control via asyncio.sleep() with None for indefinite
- Nested context managers ensure LIFO cleanup order

### Phase 4: Webhook API

**Goal**: FastAPI webhook endpoints with async processing
**Depends on**: Phase 3
**Requirements**: WEBHOOK-01, WEBHOOK-02, WEBHOOK-03, WEBHOOK-04, INFRA-02
**Plans**: 3 plans

Plans:
- [x] 04-01: FastAPI foundation with lifespan and structured logging
- [x] 04-02: Webhook endpoints and stream tracking
- [x] 04-03: Status and health check endpoints

**Details:**
- FastAPI with lifespan context manager (not deprecated @app.on_event)
- structlog with JSON output for structured logging
- Pydantic HttpUrl validation for URL parameters
- asyncio.create_task() for long-running streams
- Auto-stop previous stream when new /start arrives
- asyncio.Lock for thread safety in StreamTracker
- Health check returns "degraded" when Cast device unavailable
- uvicorn host 0.0.0.0 for Docker compatibility

### Phase 5: Production Readiness

**Goal**: Documentation and deployment configuration for production use
**Depends on**: Phase 4
**Requirements**: BROWSER-03
**Plans**: 2 plans

Plans:
- [x] 05-01: Documentation and manual testing guide (README.md, .env.example)
- [x] 05-02: Static IP configuration for Cast device discovery (CAST_DEVICE_IP)

**Details:**
- CAST_DEVICE_IP environment variable for WSL2 workaround
- pychromecast.get_chromecasts(hosts=[ip]) for static IP connection
- HTTP URL support documented as feature for local network dashboards
- Home Assistant integration examples (basic and advanced automations)
- Comprehensive README with troubleshooting guide

---

## Milestone Summary

**Key Decisions:**

- Playwright over Selenium (Rationale: Better async support and Docker compatibility)
- Context manager pattern everywhere (Rationale: Automatic resource cleanup)
- Fresh browser per request (Rationale: Avoids memory leaks and stale auth)
- Software encoding for v1 (Rationale: Hardware acceleration varies by target)
- CAST_DEVICE_IP static IP fallback (Rationale: WSL2 mDNS limitation workaround)
- asyncio.create_task for streams (Rationale: Long-running streams outlive requests)
- Auto-stop on new /start (Rationale: Seamless transition for single device)

**Issues Resolved:**

- WSL2 mDNS limitation with CAST_DEVICE_IP workaround
- Chrome SharedArrayBuffer crashes with shm_size: 2gb
- Host networking for mDNS discovery in Docker

**Issues Deferred:**

- Hardware acceleration (NVENC/VAAPI/QSV) for v2
- Multiple simultaneous Cast devices for v2
- HLS HTTP server (placeholder URL returned)

**Technical Debt Incurred:**

- Stream metadata tracking missing (/status returns "TODO" for started_at/url/quality)
- Cast device name hardcoded instead of from environment
- HTTP server for HLS streams returns placeholder URL
- Latency verification requires hardware testing to confirm <5s

---

*For current project status, see .planning/ROADMAP.md*
