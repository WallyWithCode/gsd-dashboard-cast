# Milestone v1.1: Cast Media Playback

**Status:** ✅ SHIPPED 2026-01-18
**Phases:** 6-8
**Total Plans:** 5

## Overview

Complete the Cast playback pipeline with dual-mode streaming for both dashboard reliability and camera feed low-latency.

## Phases

### Phase 6: HTTP Streaming Server

**Goal**: HTTP endpoints serve HLS and fMP4 video streams that Cast device can access
**Depends on**: Phase 5 (v1.0 complete)
**Requirements**: STRM-01, STRM-02, STRM-04, STRM-05, STRM-06, NET-01, NET-02
**Plans**: 2 plans

**Success Criteria:**
1. HTTP endpoint serves video stream accessible from Cast device's network
2. HLS mode generates playlist with `application/vnd.apple.mpegurl` content type
3. fMP4 mode generates fragmented MP4 stream with `video/mp4` content type
4. CORS headers allow Cast device access
5. Host IP auto-detected for stream URL construction

Plans:
- [x] 06-01-PLAN.md — HTTP streaming server with aiohttp and CORS
- [x] 06-02-PLAN.md — FastAPI lifespan integration and encoder URL construction

**Accomplishments:**
- Host IP detection utility that finds LAN-accessible address (not localhost)
- HTTP streaming server with proper CORS headers for Cast device access
- Content-Type mapping for HLS (m3u8, ts) and fMP4 (mp4) files
- Directory traversal protection for secure file serving
- StreamingServer starts automatically with FastAPI app on port 8080
- StreamingServer stops gracefully during FastAPI shutdown
- FFmpegEncoder returns LAN-accessible URLs using detected host IP

**Key Files:**
- Created: src/video/network.py, src/video/server.py
- Modified: src/api/main.py, src/video/encoder.py, requirements.txt

**Completed:** 2026-01-17

---

### Phase 7: FFmpeg Dual-Mode Output

**Goal**: FFmpeg pipeline produces both HLS segments and fMP4 streams based on mode parameter
**Depends on**: Phase 6
**Requirements**: ENC-01, ENC-02, ENC-03, ENC-04, STRM-03
**Plans**: 2 plans

**Success Criteria:**
1. HLS output generates MPEG-TS segments with playlist file
2. fMP4 output generates fragmented MP4 for low-latency streaming
3. H.264 High Profile Level 4.1 used for universal Cast compatibility
4. AAC audio encoding works for Cast playback
5. Mode selection via webhook parameter switches between outputs

Plans:
- [x] 07-01-PLAN.md — FFmpeg dual-mode output (HLS and fMP4)
- [x] 07-02-PLAN.md — API mode selection and parameter flow

**Accomplishments:**
- Added `mode` parameter to FFmpegEncoder: 'hls' (buffered) or 'fmp4' (low-latency)
- HLS mode produces .m3u8 playlist with .ts segments (2-second segments, keep 3)
- fMP4 mode produces fragmented MP4 with streaming-friendly movflags
- Added H.264 High Profile Level 4.1 for universal Chromecast compatibility
- Added silent audio track generation using lavfi anullsrc filter
- Added AAC audio encoding at 128kbps for Cast playback compatibility
- Mode parameter flows through entire pipeline: routes.py → StreamTracker → StreamManager → FFmpegEncoder
- Default mode is 'hls' for backward compatibility

**Key Files:**
- Modified: src/video/encoder.py, src/api/models.py, src/api/routes.py, src/api/state.py, src/video/stream.py

**Completed:** 2026-01-17

---

### Phase 8: Cast Media Playback

**Goal**: Verify media_controller wiring and mode-based stream type selection
**Depends on**: Phase 7
**Requirements**: CAST-01, CAST-02, CAST-03
**Plans**: 1 plan

**Success Criteria:**
1. `media_controller.play_media()` successfully starts playback on Cast device
2. HLS streams use BUFFERED stream_type
3. fMP4 streams use LIVE stream_type
4. Correct content_type passed based on mode

Plans:
- [x] 08-01-PLAN.md — Verify Cast media playback implementation and mode-based parameters

**Accomplishments:**
- Verified CastSessionManager.start_cast() implements mode-based playback configuration
- Verified StreamManager passes mode parameter to CastSessionManager.start_cast()
- Confirmed mode flow from webhook to Cast device through full stack
- Verified Cast playback working (video displays on TV - Google homepage rendered successfully)
- Fixed STREAM_HOST_IP from 10.10.0.100 to 10.10.0.133 to resolve Cast 404 errors

**Key Files:**
- Modified: docker-compose.yml

**Completed:** 2026-01-18

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| aiohttp over FastAPI StaticFiles for streaming | Independent server on configurable port | ✓ Good — Allows port separation (8000/8080) |
| Socket-based IP fallback for get_host_ip() | Hostname resolution may return localhost | ✓ Good — Reliable LAN IP detection |
| H.264 High Profile Level 4.1 | Universal Cast compatibility | ✓ Good — Works on all Chromecast generations |
| Silent audio via anullsrc | Cast devices expect audio tracks | ✓ Good — Prevents playback issues |
| fMP4 movflags: frag_keyframe+empty_moov+default_base_moof | Streaming-friendly fragmentation | ✓ Good — Enables low-latency streaming |
| Default mode 'hls' | Backward compatibility with existing webhooks | ✓ Good — No breaking changes |

**Issues Resolved:**
- Missing aiohttp dependency (auto-fixed during Phase 6)
- STREAM_HOST_IP incorrect value causing Cast 404 errors (fixed to 10.10.0.133)
- Mode parameter wiring through 7-layer stack (API → StreamTracker → StreamManager → FFmpegEncoder → CastSessionManager)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- HLS stream freezes after 6 seconds (buffering/segment configuration tuning needed)
  - Severity: Non-critical (quality issue)
  - Impact: Affects HLS mode playback quality
  - Workaround: fMP4 mode works without freezing
  - Future work: Tune HLS segment buffer size and timeout settings

---

_For current project status, see .planning/ROADMAP.md (will be recreated for next milestone)_
