---
phase: 08-cast-media-playback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cast/session.py
  - src/video/stream.py
autonomous: false

must_haves:
  truths:
    - "media_controller.play_media() is called with correct parameters"
    - "HLS streams use BUFFERED stream_type"
    - "fMP4 streams use LIVE stream_type"
    - "Content type matches mode (application/vnd.apple.mpegurl for HLS, video/mp4 for fMP4)"
    - "Cast device receives playback command successfully"
  artifacts:
    - path: "src/cast/session.py"
      provides: "start_cast() method with media_controller.play_media() call"
      exports: ["CastSessionManager"]
      contains: "media_controller.play_media"
    - path: "src/video/stream.py"
      provides: "StreamManager wires mode parameter to CastSessionManager"
      contains: "cast_session.start_cast"
  key_links:
    - from: "src/video/stream.py"
      to: "src/cast/session.py"
      via: "start_cast(stream_url, mode=self.mode)"
      pattern: "cast_session\\.start_cast"
    - from: "src/cast/session.py"
      to: "pychromecast media_controller"
      via: "play_media() with mode-based parameters"
      pattern: "media_controller\\.play_media"
---

<objective>
Verify Cast media playback implementation is complete and wire StreamManager to CastSessionManager with mode-based stream type selection.

Purpose: Complete the Cast playback pipeline by ensuring media_controller.play_media() is properly wired with correct content_type and stream_type parameters based on streaming mode.

Output: Verified Cast media playback implementation ready for testing once Phase 7.1 resolves streaming issues.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@.planning/phases/06-http-streaming-server/06-02-SUMMARY.md
@.planning/phases/07-ffmpeg-dual-mode/07-01-SUMMARY.md
@.planning/phases/07-ffmpeg-dual-mode/07-02-SUMMARY.md

@src/cast/session.py
@src/video/stream.py
</context>

<tasks>

<task type="auto">
  <name>Verify media_controller.play_media() implementation in CastSessionManager</name>
  <files>src/cast/session.py</files>
  <action>
    Verify that CastSessionManager.start_cast() method:

    1. Accepts mode parameter ('hls' or 'fmp4')
    2. Maps mode to correct content_type:
       - HLS: 'application/vnd.apple.mpegurl'
       - fMP4: 'video/mp4'
    3. Maps mode to correct stream_type:
       - HLS: 'BUFFERED' (for dashboard streaming with buffering)
       - fMP4: 'LIVE' (for low-latency camera feeds)
    4. Calls self.device.media_controller.play_media(media_url, content_type, stream_type=stream_type)
    5. Calls self.device.media_controller.block_until_active(timeout=10) to wait for playback
    6. Has proper error handling for session not active

    Code should already exist from commit 45577a6. Review and confirm implementation meets requirements CAST-01, CAST-02, CAST-03.

    If implementation is missing or incorrect, update start_cast() method accordingly.
  </action>
  <verify>
    grep -A 20 "def start_cast" src/cast/session.py | grep -E "play_media|content_type|stream_type|BUFFERED|LIVE"
  </verify>
  <done>
    start_cast() method correctly implements mode-based content_type and stream_type selection, calls play_media(), and waits for playback to start.
  </done>
</task>

<task type="auto">
  <name>Verify StreamManager wiring to CastSessionManager</name>
  <files>src/video/stream.py</files>
  <action>
    Verify that StreamManager.start_stream() method:

    1. Passes self.mode parameter when calling cast_session.start_cast(stream_url, mode=self.mode)
    2. Calls start_cast() within the CastSessionManager async context manager
    3. Has proper logging for playback start

    Code should already exist from commit 45577a6. Review and confirm wiring is correct.

    If wiring is missing or incorrect, update StreamManager.start_stream() to pass mode parameter to start_cast().
  </action>
  <verify>
    grep -A 5 "cast_session.start_cast" src/video/stream.py | grep "mode"
  </verify>
  <done>
    StreamManager correctly passes mode parameter to CastSessionManager.start_cast() for mode-based playback configuration.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Cast media playback implementation with mode-based content_type and stream_type selection. Implementation includes:

    - CastSessionManager.start_cast() with mode parameter
    - Mode-to-content_type mapping (HLS → application/vnd.apple.mpegurl, fMP4 → video/mp4)
    - Mode-to-stream_type mapping (HLS → BUFFERED, fMP4 → LIVE)
    - media_controller.play_media() call with correct parameters
    - StreamManager wiring to pass mode through to Cast session
  </what-built>
  <how-to-verify>
    **Note:** This verification depends on Phase 7.1 (Cast Playback Debug) resolving streaming issues. Cast device currently shows black screen/loading loop due to HLS segment 404 errors.

    Once Phase 7.1 is complete and streams are accessible:

    1. Start the service: `docker-compose up`

    2. Test HLS mode (buffered streaming):
       ```bash
       curl -X POST http://localhost:8000/start \
         -H "Content-Type: application/json" \
         -d '{
           "url": "https://example.com/dashboard",
           "quality": "720p",
           "mode": "hls"
         }'
       ```

       Expected: Cast device displays dashboard with smooth playback

    3. Test fMP4 mode (low-latency streaming):
       ```bash
       curl -X POST http://localhost:8000/start \
         -H "Content-Type: application/json" \
         -d '{
           "url": "https://example.com/camera",
           "quality": "720p",
           "mode": "fmp4"
         }'
       ```

       Expected: Cast device displays camera feed with minimal latency

    4. Check logs confirm correct parameters:
       ```bash
       docker-compose logs cast-service | grep "content_type\|stream_type"
       ```

       Expected: HLS shows content_type=application/vnd.apple.mpegurl, stream_type=BUFFERED
       Expected: fMP4 shows content_type=video/mp4, stream_type=LIVE

    **Current Status**: Implementation exists but cannot be tested until Phase 7.1 fixes streaming 404 errors.
  </how-to-verify>
  <resume-signal>
    Type "verified" once Phase 7.1 is complete and both HLS and fMP4 modes display correctly on Cast device, or "blocked" if Phase 7.1 issues persist.
  </resume-signal>
</task>

</tasks>

<verification>
## Code Verification

1. Review CastSessionManager.start_cast() implementation:
   - Mode parameter accepted
   - Content type mapping correct
   - Stream type mapping correct
   - media_controller.play_media() called with correct args

2. Review StreamManager.start_stream() wiring:
   - Mode parameter passed to start_cast()
   - Call happens within Cast session context

3. Trace mode flow from webhook to Cast device:
   - Webhook /start accepts mode parameter (Phase 7, Plan 02)
   - StreamTracker stores and passes mode (Phase 7, Plan 02)
   - StreamManager stores mode in __init__ (Phase 7, Plan 02)
   - StreamManager passes mode to start_cast() (Phase 8, Plan 01)
   - CastSessionManager maps mode to content_type and stream_type (Phase 8, Plan 01)

## Integration Verification (Blocked by Phase 7.1)

Once Phase 7.1 resolves streaming issues:

1. HLS mode playback test
2. fMP4 mode playback test
3. Log verification of correct parameters
4. Cast device display verification
</verification>

<success_criteria>
- [ ] CastSessionManager.start_cast() accepts mode parameter
- [ ] HLS mode uses content_type='application/vnd.apple.mpegurl' and stream_type='BUFFERED'
- [ ] fMP4 mode uses content_type='video/mp4' and stream_type='LIVE'
- [ ] media_controller.play_media() called with correct parameters
- [ ] StreamManager passes mode to CastSessionManager.start_cast()
- [ ] Complete mode flow traced from webhook to Cast device
- [ ] (Blocked by Phase 7.1) HLS playback displays on Cast device
- [ ] (Blocked by Phase 7.1) fMP4 playback displays on Cast device
</success_criteria>

<output>
After completion, create `.planning/phases/08-cast-media-playback/08-01-SUMMARY.md` with:

- Implementation verification results
- Mode parameter flow tracing
- Requirements CAST-01, CAST-02, CAST-03 status
- Note on Phase 7.1 dependency for integration testing
- Next steps for once Phase 7.1 is resolved
</output>
