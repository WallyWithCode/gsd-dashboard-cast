---
phase: 06-http-streaming-server
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/api/main.py
  - src/video/encoder.py
autonomous: true

must_haves:
  truths:
    - "HTTP streaming server starts with FastAPI application"
    - "HTTP streaming server stops on FastAPI shutdown"
    - "FFmpegEncoder returns URLs using detected host IP"
    - "Stream URL is accessible from Cast device's network"
  artifacts:
    - path: "src/api/main.py"
      provides: "FastAPI with integrated streaming server"
      contains: "StreamingServer"
    - path: "src/video/encoder.py"
      provides: "FFmpegEncoder with dynamic URL construction"
      contains: "get_host_ip"
  key_links:
    - from: "src/api/main.py"
      to: "StreamingServer"
      via: "lifespan context manager"
      pattern: "streaming_server.*start|stop"
    - from: "src/video/encoder.py"
      to: "get_host_ip"
      via: "import and URL construction"
      pattern: "get_host_ip.*http://"
---

<objective>
Integrate HTTP streaming server with FastAPI lifecycle and update encoder to use dynamic URLs.

Purpose: Complete the HTTP streaming infrastructure so streams are served when the application runs.
Output: Working HTTP streaming server that starts/stops with FastAPI, and FFmpegEncoder returning network-accessible URLs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@.planning/phases/06-http-streaming-server/06-01-SUMMARY.md

@src/api/main.py
@src/video/encoder.py
@src/video/server.py
@src/video/network.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate StreamingServer with FastAPI lifespan</name>
  <files>src/api/main.py</files>
  <action>
Modify src/api/main.py to:

1. Import StreamingServer from src.video.server
2. In the lifespan context manager startup:
   - Create StreamingServer instance (port 8080)
   - Store in app.state.streaming_server
   - Call await streaming_server.start()
   - Log "streaming_server_started" with port
3. In the lifespan context manager shutdown:
   - Call await app.state.streaming_server.stop()
   - Log "streaming_server_stopped"

The streaming server runs independently on port 8080 while FastAPI runs on its default port (8000).
This allows Cast device to access streams on the dedicated streaming port.

Example modification to lifespan:
```python
from src.video.server import StreamingServer

@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    configure_logging()
    logger.info("app_startup", phase="webhook-api")

    app.state.stream_tracker = StreamTracker()

    # Start streaming server
    app.state.streaming_server = StreamingServer(port=8080)
    await app.state.streaming_server.start()
    logger.info("streaming_server_started", port=8080)

    yield

    # Shutdown
    logger.info("app_shutdown", active_streams=len(app.state.stream_tracker.active_tasks))
    await app.state.stream_tracker.cleanup_all()
    await app.state.streaming_server.stop()
    logger.info("streaming_server_stopped")
```
  </action>
  <verify>
python -c "
from src.api.main import app
# Check that streaming_server is referenced in lifespan
import inspect
source = inspect.getsource(app.router.lifespan_context.__wrapped__)
assert 'streaming_server' in source.lower() or 'StreamingServer' in source
print('StreamingServer integrated in lifespan')
"
  </verify>
  <done>
    - StreamingServer starts on FastAPI startup
    - StreamingServer stops on FastAPI shutdown
    - Server stored in app.state.streaming_server
  </done>
</task>

<task type="auto">
  <name>Task 2: Update FFmpegEncoder to use dynamic host IP</name>
  <files>src/video/encoder.py</files>
  <action>
Modify src/video/encoder.py to:

1. Import get_host_ip from src.video.network
2. Add optional `port` parameter to __init__ (default 8080) for streaming server port
3. Update __aenter__ to construct URL using get_host_ip():

   Change the return statement from:
   ```python
   return f"http://localhost:8080/{output_filename}"
   ```

   To:
   ```python
   host_ip = get_host_ip()
   return f"http://{host_ip}:{self.port}/{output_filename}"
   ```

4. Store port in self.port in __init__

This ensures stream URLs are accessible from the Cast device's network, not just localhost.

The encoder already writes to /tmp/streams which the StreamingServer serves.
No other changes needed - the encoder output directory and server directory match.
  </action>
  <verify>
python -c "
from src.video.encoder import FFmpegEncoder
from src.video.quality import get_quality_config
import inspect

# Check get_host_ip is imported
source = inspect.getsource(FFmpegEncoder)
assert 'get_host_ip' in source, 'get_host_ip not found in encoder'

# Check port parameter exists
sig = inspect.signature(FFmpegEncoder.__init__)
params = list(sig.parameters.keys())
print(f'FFmpegEncoder params: {params}')

print('FFmpegEncoder updated with dynamic host IP')
"
  </verify>
  <done>
    - FFmpegEncoder imports get_host_ip
    - URL construction uses detected host IP instead of localhost
    - Port is configurable (default 8080)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.api.main import app"` imports without error
- [ ] StreamingServer referenced in FastAPI lifespan
- [ ] FFmpegEncoder uses get_host_ip() for URL construction
- [ ] No localhost hardcoding in encoder URL (except as fallback)
</verification>

<success_criteria>

- StreamingServer lifecycle managed by FastAPI lifespan
- FFmpegEncoder returns network-accessible URLs
- Both changes integrate with existing v1.0 architecture
- No breaking changes to existing API
</success_criteria>

<output>
After completion, create `.planning/phases/06-http-streaming-server/06-02-SUMMARY.md`
</output>
