---
phase: 06-http-streaming-server
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/video/network.py
  - src/video/server.py
  - src/video/__init__.py
autonomous: true

must_haves:
  truths:
    - "HTTP server serves static files from /tmp/streams directory"
    - "CORS headers allow cross-origin requests from any origin"
    - "Host IP is auto-detected for LAN accessibility"
  artifacts:
    - path: "src/video/network.py"
      provides: "Host IP detection utility"
      exports: ["get_host_ip"]
    - path: "src/video/server.py"
      provides: "HTTP streaming server with CORS"
      exports: ["StreamingServer"]
      min_lines: 50
  key_links:
    - from: "StreamingServer"
      to: "/tmp/streams"
      via: "static file serving"
      pattern: "static.*streams|FileResponse"
---

<objective>
Create HTTP server infrastructure for serving video streams to Cast devices.

Purpose: Enable Cast device to access HLS segments and fMP4 streams over HTTP with proper CORS headers.
Output: Network utility and async HTTP server module ready for FastAPI integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@src/video/encoder.py
@src/video/__init__.py
@src/api/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create host IP detection utility</name>
  <files>src/video/network.py</files>
  <action>
Create network.py module with get_host_ip() function that:
1. Uses socket.gethostname() and socket.gethostbyname() to get host IP
2. Falls back to connecting to external IP (8.8.8.8) and getting local address if hostname resolution fails
3. Returns IP address string suitable for constructing HTTP URLs accessible from Cast device

Function signature: `def get_host_ip() -> str`

Include docstring explaining this is for Cast device network accessibility.
Use structlog for any logging.
  </action>
  <verify>python -c "from src.video.network import get_host_ip; print(get_host_ip())"</verify>
  <done>Function returns valid IP address string (not 127.0.0.1 for LAN use)</done>
</task>

<task type="auto">
  <name>Task 2: Create HTTP streaming server with CORS</name>
  <files>src/video/server.py, src/video/__init__.py</files>
  <action>
Create server.py module with StreamingServer class that:

1. Uses aiohttp.web for async HTTP server (already in project from v1.0)
2. Serves static files from /tmp/streams directory
3. Sets correct Content-Type headers based on file extension:
   - .m3u8 → application/vnd.apple.mpegurl
   - .ts → video/MP2T
   - .mp4 → video/mp4
4. Adds CORS headers to all responses:
   - Access-Control-Allow-Origin: *
   - Access-Control-Allow-Methods: GET, OPTIONS
   - Access-Control-Allow-Headers: *
5. Handles OPTIONS preflight requests
6. Configurable port (default 8080)

Class API:
```python
class StreamingServer:
    def __init__(self, port: int = 8080, stream_dir: str = "/tmp/streams"):
        ...

    async def start(self) -> None:
        """Start the HTTP server."""
        ...

    async def stop(self) -> None:
        """Stop the HTTP server gracefully."""
        ...

    def get_stream_url(self, filename: str) -> str:
        """Get full HTTP URL for a stream file."""
        ...
```

Use structlog for logging.
Import get_host_ip from network.py for URL construction.

Update src/video/__init__.py to export StreamingServer and get_host_ip.

Note: Do NOT use FastAPI's StaticFiles - use aiohttp for independent server that can run on different port if needed.
  </action>
  <verify>
python -c "
import asyncio
from src.video.server import StreamingServer

async def test():
    server = StreamingServer(port=8080)
    url = server.get_stream_url('test.m3u8')
    print(f'URL: {url}')
    assert 'http://' in url
    assert ':8080' in url
    assert 'test.m3u8' in url
    print('StreamingServer initialized correctly')

asyncio.run(test())
"
  </verify>
  <done>
    - StreamingServer class exists with start(), stop(), get_stream_url() methods
    - CORS headers configured for Cast device access
    - Content-Type mapping for HLS and fMP4 files
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.video.network import get_host_ip; print(get_host_ip())"` returns valid IP
- [ ] `python -c "from src.video.server import StreamingServer"` imports without error
- [ ] StreamingServer.get_stream_url() returns properly formatted HTTP URL
- [ ] No import errors in src/video/__init__.py
</verification>

<success_criteria>

- Host IP detection returns LAN-accessible IP (not localhost/127.0.0.1)
- StreamingServer class ready for integration
- CORS headers configured for * origin
- Content-Type mapping covers m3u8, ts, mp4
</success_criteria>

<output>
After completion, create `.planning/phases/06-http-streaming-server/06-01-SUMMARY.md`
</output>
