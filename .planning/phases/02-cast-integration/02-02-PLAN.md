---
phase: 02-cast-integration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/cast/session.py
  - src/cast/retry.py
  - tests/test_cast.py
autonomous: true

must_haves:
  truths:
    - "Failed Cast connections retry with exponential backoff"
    - "Service handles Cast device unavailability gracefully"
    - "Cast module behavior is verified by tests"
  artifacts:
    - path: "src/cast/retry.py"
      provides: "Exponential backoff retry mechanism"
      min_lines: 40
      exports: ["retry_with_backoff"]
    - path: "tests/test_cast.py"
      provides: "Cast module test coverage"
      min_lines: 80
  key_links:
    - from: "src/cast/session.py"
      to: "src/cast/retry.py"
      via: "CastSessionManager uses retry_with_backoff for connections"
      pattern: "retry_with_backoff"
    - from: "tests/test_cast.py"
      to: "src/cast"
      via: "Mock pychromecast, test discovery and session lifecycle"
      pattern: "unittest\\.mock|pytest|Mock"
---

<objective>
Add retry mechanism with exponential backoff for Cast connection reliability and comprehensive test coverage for the Cast module.

Purpose: Ensure robust Cast connectivity that handles network issues and device unavailability, verified by comprehensive tests.
Output: Production-ready Cast module with retry logic and full test coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-cast-integration/02-01-SUMMARY.md

# From Plan 01:
- Cast device discovery via mDNS
- CastSessionManager with context manager pattern
- HDMI-CEC wake capability
- pychromecast integration

# Phase 1 testing patterns:
@tests/test_browser.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement exponential backoff retry mechanism</name>
  <files>src/cast/retry.py, src/cast/__init__.py</files>
  <action>
    Create src/cast/retry.py with retry_with_backoff decorator/function:

    ```python
    import asyncio
    import logging
    from typing import Callable, TypeVar, Any

    T = TypeVar('T')

    async def retry_with_backoff(
        func: Callable[..., T],
        max_retries: int = 3,
        initial_delay: float = 1.0,
        max_delay: float = 60.0,
        backoff_factor: float = 2.0,
        exceptions: tuple = (Exception,)
    ) -> T:
        """
        Retry async function with exponential backoff.

        Args:
            func: Async function to retry
            max_retries: Maximum number of retry attempts
            initial_delay: Initial delay in seconds (doubles each retry)
            max_delay: Maximum delay cap in seconds
            backoff_factor: Multiplier for delay (typically 2.0)
            exceptions: Tuple of exceptions to catch and retry

        Returns:
            Result of successful function call

        Raises:
            Last exception if all retries exhausted
        """
        delay = initial_delay
        last_exception = None

        for attempt in range(max_retries + 1):
            try:
                return await func()
            except exceptions as e:
                last_exception = e
                if attempt < max_retries:
                    logging.warning(f"Attempt {attempt + 1} failed: {e}. Retrying in {delay}s...")
                    await asyncio.sleep(delay)
                    delay = min(delay * backoff_factor, max_delay)
                else:
                    logging.error(f"All {max_retries} retries exhausted: {e}")
                    raise last_exception
    ```

    Add retry_with_backoff to src/cast/__init__.py exports.

    Update src/cast/session.py CastSessionManager.__aenter__ to use retry_with_backoff for device.wait() and connection operations:
    - Wrap device connection in retry logic
    - Use pychromecast-specific exceptions (ConnectionError, TimeoutError)
    - Log retry attempts
    - Set reasonable defaults: max_retries=3, initial_delay=1.0
  </action>
  <verify>
    - src/cast/retry.py exists with retry_with_backoff function
    - Function signature matches specification (type hints included)
    - CastSessionManager.__aenter__ uses retry_with_backoff
    - No syntax errors: python -m py_compile src/cast/retry.py src/cast/session.py
    - retry_with_backoff exported in src/cast/__init__.py
  </verify>
  <done>Exponential backoff retry mechanism implemented and integrated with Cast session manager</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive Cast module tests</name>
  <files>tests/test_cast.py</files>
  <action>
    Create tests/test_cast.py with comprehensive test coverage following Phase 1 test patterns from tests/test_browser.py.

    Test structure (minimum 6 tests):

    1. test_discover_devices_success - Mock pychromecast.get_chromecasts, verify discovery returns list
    2. test_discover_devices_empty - Mock no devices found, verify empty list (not exception)
    3. test_get_cast_device_by_name - Mock multiple devices, verify correct device selected by name
    4. test_get_cast_device_first - Mock devices, verify first device returned when name=None
    5. test_cast_session_lifecycle - Test CastSessionManager context manager (enter/exit called)
    6. test_retry_with_backoff_success - Test retry succeeds on second attempt
    7. test_retry_with_backoff_exhausted - Test all retries fail, raises last exception
    8. test_hdmi_cec_wake - Verify HDMI-CEC wake called in __aenter__

    Use pytest with pytest-asyncio (already in requirements.txt from Phase 1).
    Mock pychromecast using unittest.mock or pytest-mock.
    Test async functions with @pytest.mark.asyncio decorator.

    Follow Phase 1 patterns:
    - Clear test names describing behavior
    - Arrange-Act-Assert structure
    - Mock external dependencies (pychromecast)
    - Test both success and failure paths
    - Verify logging calls where appropriate
  </action>
  <verify>
    - tests/test_cast.py exists with minimum 6 test functions
    - All tests use @pytest.mark.asyncio for async tests
    - Mocks pychromecast dependencies (no real Cast devices needed)
    - pytest tests/test_cast.py runs successfully
    - Coverage includes discovery, session lifecycle, retry logic
  </verify>
  <done>Comprehensive test suite for Cast module covering discovery, sessions, and retry logic</done>
</task>

<task type="auto">
  <name>Task 3: Integration verification and documentation</name>
  <files>src/cast/session.py</files>
  <action>
    Add docstrings to CastSessionManager class and key methods:
    - Class docstring explaining purpose, usage pattern, HDMI-CEC behavior
    - __aenter__ docstring noting retry logic and HDMI-CEC wake
    - start_cast/stop_cast docstrings (even though placeholder for Phase 3)

    Add module-level docstring to src/cast/__init__.py explaining:
    - Cast device discovery via mDNS
    - Session management with context manager
    - Retry mechanism with exponential backoff
    - HDMI-CEC wake capability
    - Example usage snippet

    Run full test suite:
    ```bash
    pytest tests/ -v
    ```

    Verify all tests pass (browser tests from Phase 1 + new Cast tests).
  </action>
  <verify>
    - Docstrings present in CastSessionManager class and methods
    - Module-level docstring in src/cast/__init__.py with usage example
    - pytest tests/ -v passes with 0 failures
    - Both test_browser.py and test_cast.py tests succeed
  </verify>
  <done>Cast module documented and verified with full test suite passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/ passes all tests (browser + cast)
- [ ] retry_with_backoff function implemented with exponential backoff
- [ ] CastSessionManager uses retry_with_backoff for connections
- [ ] Minimum 6 Cast tests covering discovery, sessions, retry
- [ ] All Cast module classes and functions have docstrings
- [ ] No syntax or import errors in Cast module
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Retry mechanism with exponential backoff integrated
- Comprehensive test coverage for Cast module
- Full test suite (Phase 1 + Phase 2) passes
- Cast module ready for video streaming integration in Phase 3
- Requirements CAST-01 through CAST-05 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-cast-integration/02-02-SUMMARY.md`
</output>
