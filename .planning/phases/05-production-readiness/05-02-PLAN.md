---
phase: 05-production-readiness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/cast/discovery.py, docker-compose.yml]
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "User can configure Cast device via static IP"
    - "Service checks CAST_DEVICE_IP before mDNS discovery"
    - "Environment variables are documented in docker-compose.yml"
  artifacts:
    - path: "src/cast/discovery.py"
      provides: "Static IP override for Cast discovery"
      contains: "CAST_DEVICE_IP"
    - path: "docker-compose.yml"
      provides: "Documented environment variable configuration"
      contains: "CAST_DEVICE_IP"
  key_links:
    - from: "docker-compose.yml environment section"
      to: "src/cast/discovery.py"
      via: "CAST_DEVICE_IP read via os.getenv"
      pattern: "os\\.getenv.*CAST_DEVICE_IP"
---

<objective>
Add static IP configuration for Cast device discovery to address WSL2 mDNS limitation.

Purpose: Enable Cast discovery in environments where mDNS doesn't work (WSL2, some Docker configurations).
Output: CAST_DEVICE_IP environment variable support in Cast discovery, documented in docker-compose.yml.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cast-integration/02-01-SUMMARY.md
@src/cast/discovery.py
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CAST_DEVICE_IP environment variable support</name>
  <files>src/cast/discovery.py</files>
  <action>
Update discover_cast_device() function to check for CAST_DEVICE_IP environment variable before attempting mDNS discovery:

1. Import os at top of file
2. At start of discover_cast_device(), check os.getenv("CAST_DEVICE_IP")
3. If CAST_DEVICE_IP is set, skip ChromecastBrowser() and directly attempt connection to that IP:
   - Use pychromecast.get_chromecast_from_host(ip_address) or similar
   - Log: "Using static Cast device IP from CAST_DEVICE_IP environment variable"
   - Return the chromecast object if successful
   - Fall through to mDNS discovery if connection fails
4. If CAST_DEVICE_IP not set or connection fails, proceed with existing mDNS ChromecastBrowser() logic
5. Update docstring to document CAST_DEVICE_IP environment variable

This provides graceful fallback: static IP first (if configured), then mDNS discovery (if static fails or not configured).

Avoid: Don't use pychromecast.Chromecast() constructor directly - it may not include full device metadata. Use get_chromecast_from_host() or get_chromecasts() which populate device info properly.
  </action>
  <verify>
- Import os exists
- discover_cast_device() checks os.getenv("CAST_DEVICE_IP")
- Function attempts connection to static IP before mDNS
- Docstring documents CAST_DEVICE_IP
  </verify>
  <done>Cast discovery supports CAST_DEVICE_IP environment variable with graceful fallback</done>
</task>

<task type="auto">
  <name>Task 2: Document environment variables in docker-compose.yml</name>
  <files>docker-compose.yml</files>
  <action>
Update docker-compose.yml environment section with comprehensive inline comments:

```yaml
environment:
  - PYTHONUNBUFFERED=1  # Real-time log output to stdout
  - DISPLAY=:99  # Xvfb virtual display (managed by XvfbManager)
  # Optional: Static Cast device IP (WSL2 workaround for mDNS limitation)
  # - CAST_DEVICE_IP=10.10.0.31
  # Optional: Discover Cast device by friendly name
  # - CAST_DEVICE_NAME=Living Room TV
```

Keep existing variables (PYTHONUNBUFFERED, DISPLAY). Add commented-out optional variables with clear descriptions. Note WSL2 mDNS limitation for CAST_DEVICE_IP.
  </action>
  <verify>docker-compose.yml has documented environment variables with inline comments</verify>
  <done>Environment variables clearly documented with usage guidance</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/cast/discovery.py imports os
- [ ] discover_cast_device() checks CAST_DEVICE_IP before mDNS
- [ ] docker-compose.yml documents all environment variables
- [ ] Comments reference WSL2 mDNS limitation
</verification>

<success_criteria>
- All tasks completed
- Cast discovery supports static IP override
- Graceful fallback to mDNS if static IP fails
- Environment variables documented in docker-compose.yml
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/05-production-readiness/05-02-SUMMARY.md`
</output>
