---
phase: 01-browser-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - docker-compose.yml
  - .dockerignore
autonomous: true

must_haves:
  truths:
    - "Docker container runs with proper shared memory configuration"
  artifacts:
    - path: "Dockerfile"
      provides: "Docker image with Playwright and dependencies"
      min_lines: 20
      contains: "playwright install"
    - path: "docker-compose.yml"
      provides: "Docker Compose config with shm_size"
      contains: "shm_size"
  key_links:
    - from: "Dockerfile"
      to: "playwright install chromium"
      via: "RUN command installs browser binaries"
      pattern: "playwright install"
    - from: "docker-compose.yml"
      to: "shm_size: 2gb"
      via: "Shared memory config for Chrome"
      pattern: "shm_size"
---

<objective>
Package browser automation in Docker with proper shared memory configuration for headless Chrome.

Purpose: Enable containerized deployment with all dependencies and Chrome-specific requirements.
Output: Dockerfile and docker-compose.yml for service deployment.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile with Playwright dependencies</name>
  <files>Dockerfile, .dockerignore</files>
  <action>
    1. Create Dockerfile:
       - FROM python:3.11-slim as base
       - Install system dependencies: RUN apt-get update && apt-get install -y wget gnupg && rm -rf /var/lib/apt/lists/*
       - WORKDIR /app
       - COPY requirements.txt .
       - RUN pip install --no-cache-dir -r requirements.txt
       - RUN playwright install chromium && playwright install-deps chromium
       - COPY src/ ./src/
       - CMD ["python", "-m", "src.main"] (placeholder for now)

    2. Create .dockerignore:
       - __pycache__/
       - *.pyc
       - .pytest_cache/
       - .git/
       - .venv/
       - .planning/

    Critical: playwright install-deps installs OS-level dependencies (libglib, libnss, etc.) that Chrome requires. Without this, browser launch fails.

    DO NOT use alpine - Playwright requires glibc, alpine uses musl. Use -slim variant instead.
  </action>
  <verify>
    - Dockerfile exists with playwright install commands
    - .dockerignore excludes development files
    - Dockerfile uses python:3.11-slim base
  </verify>
  <done>Dockerfile builds successfully with all Playwright dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create docker-compose.yml with shared memory config</name>
  <files>docker-compose.yml</files>
  <action>
    Create docker-compose.yml:
    ```yaml
    version: '3.8'
    services:
      cast-service:
        build: .
        container_name: dashboard-cast
        shm_size: 2gb
        environment:
          - PYTHONUNBUFFERED=1
        network_mode: host
        restart: unless-stopped
    ```

    shm_size: 2gb is CRITICAL - Chrome uses shared memory for rendering. Default 64MB causes crashes with error: "SharedArrayBuffer allocation failed". 2GB is Playwright's recommendation.

    network_mode: host is needed for Cast device discovery (mDNS requires host network). This is safe for local deployment per PROJECT.md.

    DO NOT use default bridge network - Cast discovery won't work.
  </action>
  <verify>
    - docker-compose.yml exists
    - shm_size is set to 2gb
    - network_mode is set to host
  </verify>
  <done>docker-compose.yml configured with Chrome-compatible shared memory and network settings</done>
</task>

<task type="auto">
  <name>Task 3: Add build verification script</name>
  <files>scripts/test_docker.sh</files>
  <action>
    1. Create scripts/test_docker.sh:
       ```bash
       #!/bin/bash
       set -e
       echo "Building Docker image..."
       docker-compose build
       echo "Testing browser launch in container..."
       docker-compose run --rm cast-service python -c "
       from playwright.sync_api import sync_playwright
       with sync_playwright() as p:
           browser = p.chromium.launch()
           page = browser.new_page()
           page.goto('https://example.com')
           print('✓ Browser launched successfully')
           print(f'✓ Page title: {page.title()}')
           browser.close()
       "
       echo "Docker build verified"
       ```
    2. Make executable: chmod +x scripts/test_docker.sh

    This verifies:
    - Docker builds without errors
    - Playwright browser launches in container
    - Shared memory config is sufficient
    - All dependencies are installed

    DO NOT skip this verification - browser issues only appear at runtime, not build time.
  </action>
  <verify>
    - scripts/test_docker.sh exists and is executable
    - Script contains docker-compose build and browser test
  </verify>
  <done>Docker build verification script exists and tests browser launch</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] docker-compose build succeeds
- [ ] shm_size is configured in docker-compose.yml
- [ ] network_mode: host is set for Cast discovery
- [ ] Dockerfile includes playwright install-deps
- [ ] Test script verifies browser launches in container
</verification>

<success_criteria>
- All tasks completed
- Docker image builds successfully
- Browser can launch inside container with proper shared memory
- network_mode: host configured for future Cast integration
</success_criteria>

<output>
After completion, create `.planning/phases/01-browser-foundation/01-02-SUMMARY.md`
</output>
