---
phase: 09-hls-buffering-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/video/encoder.py
autonomous: false

must_haves:
  truths:
    - "HLS stream plays for 5+ minutes without freezing on Cast device"
    - "Cast device maintains 40-60 second buffer window during playback"
    - "Stream continues indefinitely until explicitly stopped via webhook"
    - "No stale HLS segments remain in /tmp/streams/ after session ends"
  artifacts:
    - path: "src/video/encoder.py"
      provides: "HLS encoding configuration with buffering parameters"
      min_lines: 290
      contains: "hls_delete_threshold"
  key_links:
    - from: "src/video/encoder.py"
      to: "FFmpeg HLS muxer"
      via: "hls_list_size, hls_delete_threshold, hls_flags parameters"
      pattern: "hls_list_size.*20"
---

<objective>
Fix HLS buffering configuration to eliminate 6-second freeze and enable indefinite streaming.

Purpose: Resolves production blocker preventing continuous HLS streaming to Cast devices. Current implementation freezes at exactly 6 seconds due to insufficient buffer window and premature segment deletion.

Output: HLS streams play indefinitely with 40-60 second buffer window, proper segment cleanup, and continuous playlist signaling.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/root/claudeProjects/WSL/gsd-dashboard-cast/.planning/PROJECT.md
@/root/claudeProjects/WSL/gsd-dashboard-cast/.planning/ROADMAP.md
@/root/claudeProjects/WSL/gsd-dashboard-cast/.planning/STATE.md
@/root/claudeProjects/WSL/gsd-dashboard-cast/.planning/REQUIREMENTS.md
@/root/claudeProjects/WSL/gsd-dashboard-cast/.planning/research/SUMMARY.md

## Prior implementation
Phase 7 implemented dual-mode FFmpeg encoding (HLS and fMP4). Current HLS configuration in encoder.py lines 138-146:
- `hls_time=2` (2-second segments)
- `hls_list_size=10` (20-second buffer, insufficient)
- `hls_flags=delete_segments+append_list` (missing omit_endlist, no deletion threshold)

## Root cause analysis
Research identified HLS segment duration vs buffer window mismatch (Pitfall #1):
- Cast devices expect minimum 3-segment buffer before playback
- Current 20s buffer causes underrun when segments deleted prematurely
- Missing omit_endlist flag signals VOD (complete) instead of live stream
- No hls_delete_threshold means segments deleted immediately after removal from playlist

## Validated solution
Industry best practices from Wowza, OTTVerse, and video.js project:
- Increase hls_list_size to 20 (40s buffer with 2s segments)
- Add hls_delete_threshold=5 (keep 5 extra segments beyond playlist)
- Add omit_endlist to hls_flags (signal continuous streaming)
- Verify GOP alignment (current g=framerate*2 is correct for 2s segments)

@/root/claudeProjects/WSL/gsd-dashboard-cast/src/video/encoder.py
</context>

<tasks>

<task type="auto">
  <name>Update HLS buffering configuration in FFmpegEncoder</name>
  <files>src/video/encoder.py</files>
  <action>
Modify HLS output configuration in build_ffmpeg_args() method (lines 138-146):

1. Change hls_list_size from 10 to 20 (provides 40s buffer with 2s segments)
2. Add hls_delete_threshold parameter set to 5 (keeps 5 segments beyond playlist size)
3. Update hls_flags from "delete_segments+append_list" to "delete_segments+append_list+omit_endlist"
   - omit_endlist signals continuous streaming (not VOD/complete)
   - Prevents Cast device from interpreting stream as finished

Expected configuration after changes:
```python
'-hls_time', '2',  # 2-second segments (unchanged)
'-hls_list_size', '20',  # 40s buffer window (was 10)
'-hls_delete_threshold', '5',  # Keep 5 extra segments (new)
'-hls_flags', 'delete_segments+append_list+omit_endlist',  # Added omit_endlist
```

Update line 143 comment to reflect new buffer size: "Keep 20 segments in playlist (40s buffer)"

IMPORTANT: Do not modify GOP size (g parameter) - current value of framerate*2 already aligns correctly with 2-second segments. Do not change hls_time (segment duration). Only modify buffer window and deletion behavior.

Rationale: Addresses HLS-01 through HLS-04 requirements by providing sufficient buffer for Cast devices, preventing premature segment deletion, and signaling continuous streaming mode.
  </action>
  <verify>
1. Run tests to confirm no syntax errors:
   ```bash
   cd /root/claudeProjects/WSL/gsd-dashboard-cast
   python3 -m pytest tests/ -v
   ```

2. Verify configuration changes applied:
   ```bash
   grep -A 5 "if self.mode == 'hls':" src/video/encoder.py
   ```
   Should show hls_list_size=20, hls_delete_threshold parameter, and omit_endlist in hls_flags.

3. Check that GOP alignment unchanged (g parameter still framerate*2):
   ```bash
   grep "'-g'" src/video/encoder.py
   ```
  </verify>
  <done>
- encoder.py HLS configuration updated with hls_list_size=20, hls_delete_threshold=5, omit_endlist flag
- All tests pass
- GOP size unchanged (remains aligned with segment duration)
  </done>
</task>

<task type="auto">
  <name>Add startup cleanup for stale HLS segments</name>
  <files>src/video/encoder.py</files>
  <action>
Add cleanup logic in __aenter__ method to remove stale segments from previous sessions before starting new encoding.

Insert after line 68 (after os.makedirs(output_dir, exist_ok=True)):

```python
# Clean up stale HLS segments from previous sessions (HLS-05)
# Prevents accumulation of orphaned .m3u8 and .ts files
if self.mode == 'hls':
    try:
        for file in os.listdir(self.output_dir):
            if file.endswith(('.m3u8', '.ts')):
                stale_path = os.path.join(self.output_dir, file)
                os.remove(stale_path)
        logger.debug(f"Cleaned up stale HLS segments from {self.output_dir}")
    except OSError as e:
        logger.warning(f"Failed to clean up stale segments: {e}")
```

Place this in __init__ method, not __aenter__, since it should run once during initialization before any encoding starts.

Alternative placement: After line 67 inside __init__ method.

Rationale: Addresses HLS-05 requirement (startup cleanup removes stale segments). Prevents disk accumulation from previous failed sessions or Docker restarts.
  </action>
  <verify>
1. Create test stale files and verify cleanup:
   ```bash
   touch /tmp/streams/test_old.m3u8 /tmp/streams/test_old0.ts
   ls -la /tmp/streams/
   ```

2. Run encoder initialization (via pytest or manual test) and verify stale files removed:
   ```bash
   python3 -c "from src.video.encoder import FFmpegEncoder; from src.video.quality import get_quality_config; enc = FFmpegEncoder(get_quality_config('720p'), mode='hls'); print('Init complete')"
   ls -la /tmp/streams/  # Should not show test_old files
   ```
  </verify>
  <done>
- Startup cleanup added to __init__ method
- Stale .m3u8 and .ts files removed before new session starts
- Manual verification confirms cleanup works
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
HLS buffering configuration updated with:
- 40-second buffer window (hls_list_size=20)
- Segment deletion threshold (hls_delete_threshold=5)
- Continuous streaming signal (omit_endlist flag)
- Startup cleanup for stale segments
  </what-built>
  <how-to-verify>
Test HLS streaming with actual Cast device to verify 6-second freeze is eliminated:

1. Start the service:
   ```bash
   cd /root/claudeProjects/WSL/gsd-dashboard-cast
   docker-compose up -d
   docker-compose logs -f
   ```

2. Trigger HLS cast (default mode):
   ```bash
   curl -X POST http://localhost:8000/start \
     -H "Content-Type: application/json" \
     -d '{
       "url": "https://example.com",
       "quality": "720p"
     }'
   ```

3. Observe Cast device playback:
   - **PASS:** Stream plays continuously for 5+ minutes without freezing
   - **PASS:** No freeze at 6-second mark (previous failure point)
   - **PASS:** Stream continues indefinitely until stopped

4. Monitor buffer in FFmpeg logs:
   ```bash
   docker-compose logs -f | grep -i hls
   ```
   Should show playlist with 20 segments being maintained.

5. Stop cast and verify cleanup:
   ```bash
   curl -X POST http://localhost:8000/stop
   docker exec -it gsd-dashboard-cast ls -la /tmp/streams/
   ```
   Should show no leftover .m3u8 or .ts files (or only current session files).

6. Test multiple start/stop cycles:
   - Start cast, let it play 30s, stop
   - Repeat 3 times
   - Verify no disk accumulation in /tmp/streams/

**Expected outcomes:**
- Stream plays 5+ minutes continuously (HLS-01)
- Cast device maintains 40-60s buffer (HLS-02)
- Playlist includes omit_endlist (HLS-03, verify with `curl http://10.10.0.133:8080/stream_*.m3u8`)
- No stale segments after session end (HLS-05)

**If stream still freezes:**
- Check FFmpeg logs for "Non-monotonous DTS" errors (indicates GOP misalignment)
- Verify Cast device can reach streaming server (ping 10.10.0.133 from TV)
- Check /tmp/streams/ for segment files being created (should see stream_*.ts files)
  </how-to-verify>
  <resume-signal>
Type "approved" if stream plays continuously without freezing, or describe any issues observed (e.g., "still freezes at 6s", "segments not deleted", etc.)
  </resume-signal>
</task>

</tasks>

<verification>
## HLS buffering requirements coverage

**HLS-01: HLS streams play indefinitely without freezing**
- hls_list_size increased to 20 (40s buffer)
- omit_endlist flag signals continuous streaming
- Verified via 5+ minute playback test

**HLS-02: HLS buffer window configured for 40-60s buffer**
- hls_list_size=20 with hls_time=2 provides 40s playlist window
- hls_delete_threshold=5 provides additional 10s retention (50s total)
- Buffer verified in FFmpeg logs and playlist inspection

**HLS-03: EVENT playlist type or omit_endlist flag enabled**
- omit_endlist flag added to hls_flags
- Cast device interprets stream as continuous, not VOD

**HLS-04: GOP keyframes aligned with segment duration**
- Existing g=framerate*2 setting produces 2s GOP for normal mode
- Matches hls_time=2 segment duration (no change needed)
- Low-latency mode uses g=framerate (1s GOP, still aligned)

**HLS-05: Startup cleanup removes stale HLS segments**
- __init__ method clears all .m3u8 and .ts files before encoding
- Prevents disk accumulation from previous sessions
- Verified via manual file creation test

## Cast device compatibility

- Content-Type: application/vnd.apple.mpegurl (already set in Phase 8)
- Stream type: BUFFERED (already set in Phase 8)
- Segment duration: 2s (optimal for network streaming per research)
- Codec: H.264 High Profile Level 4.1 + AAC (already set in Phase 7)

## Edge cases handled

- Orphaned segments from crashed sessions: Startup cleanup
- Segments deleted while Cast still buffering: hls_delete_threshold=5
- Cast device misinterpreting playlist as complete: omit_endlist flag
- Cleanup failures: OSError caught and logged, doesn't block startup
</verification>

<success_criteria>
Phase 9 complete when:
- [ ] HLS configuration updated in encoder.py (hls_list_size=20, hls_delete_threshold=5, omit_endlist)
- [ ] Startup cleanup added to remove stale segments
- [ ] All tests pass
- [ ] HLS stream verified playing 5+ minutes continuously on Cast device (human verification)
- [ ] No 6-second freeze observed
- [ ] No stale segments accumulate in /tmp/streams/
- [ ] All 5 HLS requirements (HLS-01 through HLS-05) met
</success_criteria>

<output>
After completion, create `/root/claudeProjects/WSL/gsd-dashboard-cast/.planning/phases/09-hls-buffering-fix/09-01-SUMMARY.md` following summary.md template.

Include:
- Configuration changes applied (before/after values)
- Human verification results (playback duration, freeze occurrence)
- Buffer window measurements (if observable from logs)
- Any Cast device behavior notes during testing
</output>
