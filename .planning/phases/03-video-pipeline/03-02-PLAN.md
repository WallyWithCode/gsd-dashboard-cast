---
phase: 03-video-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/video/capture.py, scripts/start_xvfb.sh, docker-compose.yml]
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "Xvfb virtual display starts successfully on :99"
    - "Browser can connect to Xvfb display"
    - "Video capture module provides display configuration"
  artifacts:
    - path: "src/video/capture.py"
      provides: "Xvfb display management and configuration"
      min_lines: 50
      exports: ["XvfbManager"]
    - path: "scripts/start_xvfb.sh"
      provides: "Xvfb startup script for Docker container"
      min_lines: 10
  key_links:
    - from: "BrowserManager"
      to: "DISPLAY environment variable"
      via: "uses Xvfb display for rendering"
      pattern: "DISPLAY=:99"
    - from: "FFmpegEncoder"
      to: "Xvfb display"
      via: "captures frames from virtual display"
      pattern: "x11grab.*:99"
---

<objective>
Implement Xvfb-based video capture for headless browser rendering to video stream.

Purpose: Provide virtual display infrastructure that enables browser rendering to be captured by FFmpeg without requiring a physical display. This completes the browser → video pipeline.

Output: Xvfb display management module and Docker configuration for virtual display.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/ARCHITECTURE.md
@.planning/research/STACK.md

# Prior phase context
@.planning/phases/01-browser-foundation/01-01-SUMMARY.md — BrowserManager with context manager pattern
@.planning/phases/01-browser-foundation/01-02-SUMMARY.md — Docker configuration patterns

# Research findings:
- Xvfb provides virtual X11 framebuffer for headless rendering
- Use -screen 0 1920x1080x24 to set display resolution
- FFmpeg x11grab captures directly from display buffer
- Start Xvfb before browser launch, use DISPLAY env var
- One Xvfb instance per container (v1), per-stream isolation (v2)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Xvfb manager module</name>
  <files>src/video/capture.py</files>
  <action>
Create src/video/capture.py with XvfbManager class using async context manager pattern.

Class structure:

class XvfbManager:
    """Manages Xvfb virtual display lifecycle.

    Provides a virtual X11 display for headless browser rendering that can
    be captured by FFmpeg. Ensures proper cleanup of Xvfb process on exit.

    Usage:
        async with XvfbManager(display=':99', resolution=(1920, 1080)) as manager:
            # DISPLAY environment variable set automatically
            # Launch browser here
        # Xvfb process cleaned up on exit
    """

Methods:

1. __init__(self, display: str = ':99', resolution: tuple[int, int] = (1920, 1080), depth: int = 24):
   - Store display number (e.g., ':99')
   - Store resolution tuple (width, height)
   - Store color depth
   - Initialize process handle to None
   - Log configuration

2. async __aenter__(self) -> str:
   - Build Xvfb command: ['Xvfb', display, '-screen', '0', f'{width}x{height}x{depth}', '-ac', '-nolisten', 'tcp']
   - Start Xvfb subprocess with asyncio.create_subprocess_exec
   - Wait 1 second for Xvfb to initialize
   - Set DISPLAY environment variable: os.environ['DISPLAY'] = display
   - Verify Xvfb is running (check process poll() returns None)
   - Log success with display and resolution
   - Store process handle
   - Return display string (e.g., ':99')

3. async __aexit__(self, exc_type, exc_val, exc_tb):
   - Log cleanup start
   - If process exists:
     - Terminate gracefully (process.terminate(), wait 3s)
     - If still running, kill forcefully (process.kill())
   - Unset DISPLAY environment variable (os.environ.pop('DISPLAY', None))
   - Log cleanup complete
   - Don't suppress exceptions

4. get_display_info(self) -> dict:
   - Return dict with display, resolution, depth for reference
   - Used by other components to verify display config

Error handling:
- Check Xvfb is available in PATH before starting
- Handle subprocess spawn failures with clear error message
- Log Xvfb stderr if process fails
- Raise RuntimeError if Xvfb fails to start after timeout

Import requirements: asyncio, subprocess, os, logging, time.sleep (for delays)
  </action>
  <verify>python -c "import asyncio; from src.video.capture import XvfbManager; print('XvfbManager imports successfully')"</verify>
  <done>XvfbManager class exists with async context manager, starts/stops Xvfb process, sets DISPLAY env var</done>
</task>

<task type="auto">
  <name>Task 2: Create Xvfb startup script for Docker</name>
  <files>scripts/start_xvfb.sh, docker-compose.yml</files>
  <action>
Create scripts/start_xvfb.sh:

```bash
#!/bin/bash
# Start Xvfb virtual display for video capture

set -e

DISPLAY="${DISPLAY:-:99}"
RESOLUTION="${XVFB_RESOLUTION:-1920x1080}"
DEPTH="${XVFB_DEPTH:-24}"

echo "Starting Xvfb on display $DISPLAY with resolution ${RESOLUTION}x${DEPTH}"

# Start Xvfb in background
Xvfb "$DISPLAY" -screen 0 "${RESOLUTION}x${DEPTH}" -ac -nolisten tcp &
XVFB_PID=$!

# Wait for Xvfb to be ready
sleep 2

# Verify Xvfb is running
if ! kill -0 $XVFB_PID 2>/dev/null; then
    echo "ERROR: Xvfb failed to start"
    exit 1
fi

echo "Xvfb started successfully (PID: $XVFB_PID)"

# Keep script running to maintain Xvfb process
wait $XVFB_PID
```

Make executable: chmod +x scripts/start_xvfb.sh

Update docker-compose.yml to ensure Xvfb dependencies are available:

In the service definition, verify these are present (should already exist from Phase 1, just verify):
- Base image includes Xvfb (mcr.microsoft.com/playwright or custom with xvfb package)
- shm_size: '2gb' (for Chrome shared memory)
- Add environment variable: DISPLAY=:99

Add comment in docker-compose.yml noting Xvfb will be started by Python code via XvfbManager (not as separate service).
  </action>
  <verify>bash -n scripts/start_xvfb.sh && cat docker-compose.yml | grep -E "shm_size|DISPLAY"</verify>
  <done>Xvfb startup script exists and is executable, docker-compose.yml has correct configuration for Xvfb operation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] XvfbManager can be imported without errors
- [ ] Xvfb startup script is valid bash and executable
- [ ] docker-compose.yml includes shm_size and can set DISPLAY env var
- [ ] Context manager pattern matches established patterns
- [ ] Display configuration (resolution, depth) is accessible
</verification>

<success_criteria>

- All tasks completed without errors
- XvfbManager module exists with async context manager
- Xvfb startup script exists for Docker container
- Docker configuration supports Xvfb operation
- DISPLAY environment variable management works correctly
- Code follows established async patterns from prior phases
  </success_criteria>

<output>
After completion, create `.planning/phases/03-video-pipeline/03-02-SUMMARY.md`
</output>
