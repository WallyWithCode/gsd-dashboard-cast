---
phase: 10-intel-quicksync-hardware-acceleration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - docker-compose.yml
autonomous: true

must_haves:
  truths:
    - Docker image contains FFmpeg 7.0+ with h264_qsv encoder support
    - Docker container can access /dev/dri/renderD128 device
    - Container user has render and video group permissions
  artifacts:
    - path: Dockerfile
      provides: Intel media driver installation and FFmpeg 7.0+ verification
      contains: intel-media-va-driver-non-free
    - path: docker-compose.yml
      provides: Device passthrough configuration
      contains: "/dev/dri:/dev/dri"
  key_links:
    - from: Dockerfile
      to: intel-media-va-driver-non-free package
      via: apt-get install
      pattern: "intel-media-va-driver-non-free"
    - from: docker-compose.yml
      to: /dev/dri device
      via: devices configuration
      pattern: "/dev/dri:/dev/dri"
---

<objective>
Configure Docker infrastructure to support Intel QuickSync hardware acceleration by installing Intel media drivers in the container and enabling GPU device passthrough.

Purpose: Enables FFmpeg to access Intel integrated GPU for h264_qsv encoder, required for 80-90% CPU reduction vs software encoding
Output: Updated Dockerfile and docker-compose.yml with QuickSync support
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-intel-quicksync-hardware-acceleration/10-RESEARCH.md

# Current implementation
@Dockerfile
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Update Dockerfile with Intel media drivers</name>
  <files>Dockerfile</files>
  <action>
Add Intel QuickSync support to Dockerfile by installing media drivers and VAAPI tools.

Modify the apt-get install line (currently line 5) to include:
- intel-media-va-driver-non-free (iHD VAAPI driver for Gen 8+ Intel GPUs)
- vainfo (hardware capability detection tool)
- libva2 (Video Acceleration API library)
- libva-drm2 (VAAPI DRM display support)

Keep existing packages (wget, gnupg, ffmpeg, xvfb).

After apt-get install block, add verification step to confirm FFmpeg 7.0+ with h264_qsv:
```dockerfile
# Verify FFmpeg 7.0+ with OneVPL support and h264_qsv encoder availability
RUN ffmpeg_version=$(ffmpeg -version | head -1 | grep -oP 'ffmpeg version \K[0-9]+\.[0-9]+' || echo "0.0") && \
    major_version=$(echo "$ffmpeg_version" | cut -d. -f1) && \
    echo "FFmpeg version: $ffmpeg_version (major: $major_version)" && \
    if [ "$major_version" -lt 7 ]; then \
        echo "ERROR: FFmpeg 7.0+ required for OneVPL support (found: $ffmpeg_version)"; \
        exit 1; \
    fi && \
    ffmpeg -encoders 2>/dev/null | grep h264_qsv || echo "WARNING: h264_qsv not found - hardware acceleration unavailable"
```

This verification explicitly checks:
1. FFmpeg version is 7.0 or higher (HWAC-07 requirement for OneVPL support)
2. h264_qsv encoder is available in the build

Reference: Research RESEARCH.md "Standard Stack" section (HWAC-07: FFmpeg 7.0+ includes OneVPL by default on Debian/Ubuntu) and "Dockerfile - Install Intel Media Drivers" code example.

DO NOT add i965-va-driver (legacy driver, archived Jan 2025).
DO NOT add libmfx1 or intel-gpu-tools (not required for basic QuickSync support).
  </action>
  <verify>
docker build . -t test-qsv
docker run --rm test-qsv sh -c "ffmpeg -version | head -1 && ffmpeg -encoders | grep h264_qsv"
  </verify>
  <done>Build succeeds, FFmpeg version 7.0+ verified, h264_qsv encoder appears in ffmpeg -encoders output</done>
</task>

<task type="auto">
  <name>Update docker-compose.yml with GPU passthrough</name>
  <files>docker-compose.yml</files>
  <action>
Add GPU device passthrough and group permissions to docker-compose.yml for QuickSync access.

Add three new sections under the cast-service service (after environment section, before ports):

1. devices section:
```yaml
    devices:
      - /dev/dri:/dev/dri  # Pass entire DRI directory (card0 and renderD128)
```

2. group_add section (with placeholder detection script):
```yaml
    group_add:
      - "RENDER_GID"  # Replace with actual GID from: getent group render | cut -d: -f3
      - "VIDEO_GID"   # Replace with actual GID from: getent group video | cut -d: -f3
```

3. Add LIBVA_DRIVER_NAME environment variable to force iHD driver:
```yaml
      - LIBVA_DRIVER_NAME=iHD  # Force iHD driver for Gen 8+ Intel GPUs
```

Add comments explaining:
- devices: Required for FFmpeg to access Intel GPU
- group_add: Container user needs render/video group permissions for /dev/dri access
- LIBVA_DRIVER_NAME: Prevents wrong driver selection on multi-GPU systems

Create helper script `scripts/detect-gpu-gids.sh`:
```bash
#!/bin/bash
# Detect render and video group IDs for GPU passthrough
echo "Detecting GPU device group IDs..."
echo ""
RENDER_GID=$(getent group render 2>/dev/null | cut -d: -f3)
VIDEO_GID=$(getent group video 2>/dev/null | cut -d: -f3)

if [ -z "$RENDER_GID" ]; then
  echo "WARNING: render group not found"
else
  echo "RENDER_GID: $RENDER_GID"
fi

if [ -z "$VIDEO_GID" ]; then
  echo "WARNING: video group not found"
else
  echo "VIDEO_GID: $VIDEO_GID"
fi

echo ""
echo "Update docker-compose.yml group_add section with these values:"
echo "    group_add:"
echo "      - \"${RENDER_GID:-RENDER_GID_NOT_FOUND}\""
echo "      - \"${VIDEO_GID:-VIDEO_GID_NOT_FOUND}\""
```

Make script executable: `chmod +x scripts/detect-gpu-gids.sh`

Add comment above group_add in docker-compose.yml:
```yaml
    # GPU group permissions - Run scripts/detect-gpu-gids.sh to get actual GIDs
    group_add:
      - "RENDER_GID"  # Replace with actual GID from detect-gpu-gids.sh
      - "VIDEO_GID"   # Replace with actual GID from detect-gpu-gids.sh
```

Reference: Research RESEARCH.md "Docker Device Passthrough Configuration" pattern.

DO NOT use hardcoded GIDs like "104" or "44" - these vary by distribution.
  </action>
  <verify>
docker-compose config validates successfully
grep -E "(devices|group_add|LIBVA_DRIVER_NAME)" docker-compose.yml shows new configuration
test -x scripts/detect-gpu-gids.sh && echo "Script is executable"
scripts/detect-gpu-gids.sh
  </verify>
  <done>docker-compose.yml contains devices, group_add (with placeholder), and LIBVA_DRIVER_NAME configuration with explanatory comments; scripts/detect-gpu-gids.sh exists and detects host GIDs</done>
</task>

</tasks>

<verification>
Overall verification:
- docker build completes successfully
- docker-compose config validates
- Dockerfile contains intel-media-va-driver-non-free and verification step showing FFmpeg 7.0+ version
- docker-compose.yml contains /dev/dri device passthrough and group_add configuration
- scripts/detect-gpu-gids.sh detects render and video GIDs on host
</verification>

<success_criteria>
- Dockerfile installs Intel media drivers (intel-media-va-driver-non-free, vainfo, libva2, libva-drm2)
- Dockerfile verification step checks FFmpeg 7.0+ (HWAC-07) and h264_qsv encoder availability
- docker-compose.yml passes /dev/dri device to container
- docker-compose.yml includes group_add for render and video groups with placeholder values
- docker-compose.yml sets LIBVA_DRIVER_NAME=iHD environment variable
- Helper script scripts/detect-gpu-gids.sh detects and displays actual GIDs
- All configuration changes include explanatory comments
</success_criteria>

<output>
After completion, create `.planning/phases/10-intel-quicksync-hardware-acceleration/10-01-SUMMARY.md`
</output>
